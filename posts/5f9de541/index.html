<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>node-v8 Isolate和GC | DZ&#39;s Gensokyo | Best Time, Best You and Me</title><meta name="author" content="Derek Zhou"><meta name="description" content="life are flashes and here is my life"><meta name="keywords" content="node,v8"><meta id="viewport" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta property="og:title" content="node-v8 Isolate和GC"><meta property="og:site_name" content="DZ&#39;s Gensokyo"><meta property="og:image" content="/favicon.ico"><link href="/favicon.ico" rel="icon"><link rel="alternate" href="/atom.xml" title="DZ&#39;s Gensokyo" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"></head><body><div class="blog"><div class="content"><header><div class="site-branding"><h1 class="site-title"><a href="/">DZ&#39;s Gensokyo</a></h1><p class="site-description">Best Time, Best You and Me</p></div><nav class="site-navigation"><ul><li><a href="/">主页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li></ul></nav></header><main class="site-main posts-loop"><article><h3 class="article-title"><span>node-v8 Isolate和GC</span></h3><div class="article-top-meta"><span class="posted-on"><a href="/posts/5f9de541/" rel="bookmark"><time class="entry-date published" datetime="2018-01-06T07:51:30.000Z">2018-01-06</time></a></span></div><div class="article-content"><div class="entry"><p>&emsp;&emsp;Node/V8学习笔记系列1，关于Isolate（V8实例）和GC（垃圾回收机制）。</p><a id="more"></a><h3 id="JavaScript引擎"><a href="#JavaScript引擎" class="headerlink" title="JavaScript引擎"></a>JavaScript引擎</h3><p><img src="http://opo02jcsr.bkt.clouddn.com/7b6d799a60dcdda8f8321e54d4cd65db.png" alt=""></p><p>js引擎：源代码-&gt;抽象语法树AST-&gt;字节码-&gt;JIT-&gt;本地代码<br>V8：AST-&gt;JIT-&gt;本地代码</p><h3 id="V8"><a href="#V8" class="headerlink" title="V8"></a>V8</h3><h4 id="Isolate"><a href="#Isolate" class="headerlink" title="Isolate"></a>Isolate</h4><p>&emsp;&emsp;V8引擎实例，是一个独立的虚拟机，对应一个或多个线程，但同时只允许一个线程进入。Isolate之间完全隔离，不共享任何资源。</p><p><img src="http://opo02jcsr.bkt.clouddn.com/c5e9cafc6bd2eb777027f92b22eed647.png" alt=""></p><ul><li><p>Handle<br>&emsp;&emsp;V8对所有js值和对象的内存分配都是在Heap内，Heap由V8独立维护，失去引用的对象会被GC回收。Handle是对Heap中对象的引用，GC需要管理Handle，对象的Handle引用变化时GC可以回收该对象或者移动该对象的分区。<br>&emsp;&emsp;Handle分为Local和Persistance两种。前者为局部对象，后者类似全局对象，需要类似于C++的new和delete的操作Persistent::New, Persistent::Dispose进行内存管理。<br>&emsp;&emsp;Persistent::MakeWeak可以弱化引用，触发GC对被引用对象的回收。</p></li><li><p>Scope<br>&emsp;&emsp;作用域，是Handle（句柄）的容器，一个作用域内可以有很多句柄。<br>&emsp;&emsp;HandleScope用于管理Handle，Context::Scope用于管理Context对象</p></li><li><p>Context<br>&emsp;&emsp;上下文环境，也可以理解为运行环境。<br>&emsp;&emsp;例如：在A函数内有一个Context，调用B函数，又有一个Context，退出B回到A时又恢复了A的Context。</p></li></ul><h4 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h4><p>&emsp;&emsp;基本问题：识别需要回收的内存。<br>&emsp;&emsp;根对象或者被另一个活跃对象引用的对象是活跃的。</p><ul><li><p>V8的堆构成<br><img src="http://opo02jcsr.bkt.clouddn.com/dce361c2c729b461e24b5582c56c3d8f.png" alt=""></p></li><li><p>识别指针<br>&emsp;&emsp;通过在指针的末位标记这个字是指针还是对象</p></li><li><p>对象晋升<br>&emsp;&emsp;对象在经历了多次新生代的清理后还幸存的时候，会被移动到老生代，即被晋升</p></li><li><p>跨区指向<br>&emsp;&emsp;新对象诞生时并没有指向他的指针，比如在老生区对象写操作的时候，产生了一个队新对象的引用，此时在写缓冲区被记录下这样的跨区指向。</p></li><li><p>GC三步曲</p><ul><li>枚举根节点引用</li><li>发现并标记活跃对象</li><li>垃圾内存清理<br>分代回收分两种：Scavenge和Mark-Sweep<ul><li>Scavenge 分配指针达到新生代末尾时清理</li><li>Mark-Sweep 活跃超过两个小周期的对象，需要将其移动到老生区</li></ul></li></ul></li></ul></div></div><div class="article-footer"><div class="article-meta pull-left"><span class="post-categories"><i class="icon-categories"></i> <a href="/categories/code/">code</a> </span><span class="post-tags"><i class="icon-tags"></i> <a href="/tags/node/">node</a><a href="/tags/v8/">v8</a></span></div></div></article></main><footer class="site-footer"><p class="site-info">Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a><br>&copy; 2018 Derek Zhou</p></footer></div></div></body></html>