<!DOCTYPE HTML><html><head><meta charset="utf-8"><title>dz-pj 在线音乐SPA | DZ&#39;s Gensokyo | Best Time, Best You and Me</title><meta name="author" content="Derek Zhou"><meta name="description" content="life are flashes and here is my life"><meta name="keywords" content="react"><meta id="viewport" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta property="og:title" content="dz-pj 在线音乐SPA"><meta property="og:site_name" content="DZ&#39;s Gensokyo"><meta property="og:image" content="/favicon.ico"><link href="/favicon.ico" rel="icon"><link rel="alternate" href="/atom.xml" title="DZ&#39;s Gensokyo" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"></head><body><div class="blog"><div class="content"><header><div class="site-branding"><h1 class="site-title"><a href="/">DZ&#39;s Gensokyo</a></h1><p class="site-description">Best Time, Best You and Me</p></div><nav class="site-navigation"><ul><li><a href="/">主页</a></li><li><a href="/archives">归档</a></li></ul></nav></header><main class="site-main posts-loop"><article><h3 class="article-title"><span>dz-pj 在线音乐SPA</span></h3><div class="article-top-meta"><span class="posted-on"><a href="/posts/f0693436/" rel="bookmark"><time class="entry-date published" datetime="2018-01-19T05:04:54.000Z">2018-01-19</time></a></span></div><div class="article-content"><div class="entry"><p>&emsp;&emsp;一时兴起，写了个简单的音乐站，满足自己平时听歌的需要。欢迎朋友们试用、提<a href="https://github.com/derekeeeeely/dz-music/issues" target="_blank" rel="noopener">issue</a>、<a href="https://github.com/derekeeeeely/dz-music" target="_blank" rel="noopener">star</a>~<br><a id="more"></a></p><p><img src="http://opo02jcsr.bkt.clouddn.com/0e03890a35c76d2eb7c7ec9c951bcd1e.png" alt=""></p><h3 id="相关技术点"><a href="#相关技术点" class="headerlink" title="相关技术点"></a>相关技术点</h3><ul><li>view<ul><li>react</li><li>antd<br>平时做中后台业务习惯了，图个方便直接拿来用了，也不是很丑…</li></ul></li><li>store<ul><li>mobx<br>相比于redux更轻，代码侵入小，虽然没有中间件，但小应用也够用来管理前端状态了</li></ul></li><li>server<ul><li>axios<br>图个方便简单…后续封装个完善的请求模块</li><li><a href="https://github.com/Binaryify/NeteaseCloudMusicApi" target="_blank" rel="noopener">NeteaseCloudMusicApi</a><br>在自己的server上clone了大佬的这个项目，跑起来以后为前端提供api，获取数据源</li></ul></li><li>打包部署<ul><li><a href="https://github.com/parcel-bundler/parcel" target="_blank" rel="noopener">parcel</a><br>如官网所说，零配置，作为嫌弃webpack麻烦到死的我来说真的是够用了。<ul><li>优势<br>自带热更新<br>零配置<br>速度快</li><li>劣势<br>热更新有问题<br>没有sourceMap，调试很麻烦</li></ul></li><li>nginx<ul><li>简单配置</li></ul></li><li>steps<ul><li>本地build</li><li>上传github repo</li><li>server上<code>git pull</code></li></ul></li></ul></li></ul><h3 id="项目核心"><a href="#项目核心" class="headerlink" title="项目核心"></a>项目核心</h3><p>&emsp;&emsp;由于audio和lyric是两个分开的组件，为了维护状态，这两个组件看起来都不是很独立。<br>&emsp;&emsp;后续考虑封装成一个更合理，更封闭的组件，比如对使用者来说只要传入musicList就可用。</p><h4 id="audio组件"><a href="#audio组件" class="headerlink" title="audio组件"></a>audio组件</h4><ul><li><p>思路</p><ul><li><p>监听audio组件的事件<br>举个栗子</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实时进度条</span></span><br><span class="line"><span class="keyword">this</span>.audio.addEventListener(<span class="string">'timeupdate'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> progress = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 下一首的时候会先进到这里？！没获取到长度的时候会报错</span></span><br><span class="line">  <span class="keyword">if</span> (!!<span class="keyword">this</span>.audio.duration) &#123;</span><br><span class="line">    progress = (<span class="keyword">this</span>.audio.currentTime / <span class="keyword">this</span>.audio.duration) * <span class="number">100</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.props.passTime(<span class="keyword">this</span>.audio.currentTime)</span><br><span class="line">  <span class="keyword">this</span>.props.form.setFieldsValue(&#123;</span><br><span class="line">    slider: progress</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">    progress</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>播放过程中监听时间变化，显示实时进度条、定位实时歌词位置。</p></li></ul></li><li><p>使用</p><ul><li>props<ul><li>passTime (func)，用于将当前时间传出，存入store，方便lyric定位歌词位置</li><li>musicList，播放列表</li><li>insertMark，插入播放列表标志位 // 后续考虑优化</li><li>changeMark (func)，用于将当前歌曲在播放列表中位置传出，存入store，方便lyric获取歌词</li></ul></li><li>功能<ul><li>支持搜索歌曲，添加到播放列表</li><li>支持播放歌曲、切换上下首、切换循环单曲和列表顺序模式</li><li>支持播放中拖动进度条、显示当前时间、调节播放音量</li></ul></li></ul></li></ul><h4 id="lyric-flow组件"><a href="#lyric-flow组件" class="headerlink" title="lyric flow组件"></a>lyric flow组件</h4><ul><li><p>思路</p><ul><li><p>parse歌词字符串<br>从网易云获取到的歌词长这样：<br><img src="http://opo02jcsr.bkt.clouddn.com/cbae09421c6c201ec6a3e1bc7c084a00.png" alt=""><br>我想要的是这样的：<br><img src="http://opo02jcsr.bkt.clouddn.com/61b427ffe5b3fe9dcf6c5b3dd7b240d4.png" alt=""></p><p>parse细节如下，其实也很简单，只要把对应歌词和时间对应上就好了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">parse</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> lines = text.split(<span class="string">'\n'</span>)</span><br><span class="line">  <span class="keyword">const</span> pattern = <span class="regexp">/\[\d&#123;2&#125;:\d&#123;2&#125;.\d*\]/g</span></span><br><span class="line">  <span class="keyword">const</span> lyrics = []</span><br><span class="line">  lines.map(<span class="function"><span class="params">line</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> timeLines = line.match(pattern)</span><br><span class="line">    <span class="keyword">const</span> lyricLine = line.replace(pattern, <span class="string">""</span>)</span><br><span class="line">    <span class="keyword">if</span>(timeLines &amp;&amp; timeLines.length) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;timeLines.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> timeLine = timeLines[i]</span><br><span class="line">        <span class="keyword">const</span> min = timeLine.replace(<span class="regexp">/(\[|\:|\]|\.)/g</span>, <span class="string">""</span>).slice(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">const</span> sec = timeLine.replace(<span class="regexp">/(\[|\:|\]|\.)/g</span>, <span class="string">""</span>).slice(<span class="number">2</span>, <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">const</span> seconds = (+min) * <span class="number">60</span> + (+sec)</span><br><span class="line">        lyrics.push(&#123;</span><br><span class="line">          [seconds]: lyricLine || <span class="string">'......'</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  lyrics.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyA = +<span class="built_in">Object</span>.keys(a)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">const</span> keyB = +<span class="built_in">Object</span>.keys(b)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> keyA - keyB</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> lyrics</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>监听播放时间，根据时间对应找到落在的歌词位置，显示旁边两条歌词</p></li></ul></li><li><p>使用</p><ul><li>props<ul><li>lyric 当前歌曲的歌词</li><li>currentTime 当前播放时间</li></ul></li><li>功能<ul><li>现在是显示两条，后续考虑做成文字走马灯，高亮当前播放的一条</li></ul></li></ul></li></ul><h3 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h3><h4 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h4><ul><li>audio<ul><li>以前基本没用过，现在至少知道了一些生命周期事件以及常用属性的</li></ul></li><li>mobx<ul><li>和redux思想感觉是蛮接近的，都是单一数据源，都符合flux思想</li><li>组件都需要去订阅store，mobx用inject，redux需要connect</li><li>redux把store搞成一个大块头，mobx把多个store分开</li><li>mobx直接通过action更新store，redux则通过action去调用reducer更新store</li><li>redux数据流的概念使得可以加入中间件，更好地处理异步请求</li><li>小型应用用mobx绝对是方便快捷的</li></ul></li><li>正则<ul><li>是个好东西，虽然以前基本不写，但感觉还是要好好学，学好将受益无穷啊</li></ul></li><li>willReceiveProps<ul><li>以前用得少，最近疯狂在用，是时候回顾下react生命周期了</li></ul></li></ul><h4 id="待挖掘"><a href="#待挖掘" class="headerlink" title="待挖掘"></a>待挖掘</h4><ul><li>react-router 4</li><li>react 16</li><li>parcel</li></ul><p>这些东西都用上了，但是没有去具体了解，接下来会找个项目的机会好好研究下。</p></div></div><div class="article-footer"><div class="article-meta pull-left"><span class="post-categories"><i class="icon-categories"></i> <a href="/categories/projects/">projects</a> </span><span class="post-tags"><i class="icon-tags"></i> <a href="/tags/react/">react</a></span></div></div></article></main><footer class="site-footer"><p class="site-info">Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a><br>&copy; 2018 Derek Zhou</p></footer></div></div></body></html>